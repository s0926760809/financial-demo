# ğŸ” Tetragon eBPF å®‰å…¨ç›£æ§ç³»çµ± - ç¬¬ä¸€éšæ®µæ ¸å¿ƒåŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¦‚è¦½

æœ¬ç³»çµ±æˆåŠŸå¯¦ç¾äº†ç¬¬ä¸€éšæ®µçš„ä¸‰å€‹æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›äº†å®Œæ•´çš„ eBPF å®‰å…¨äº‹ä»¶ç›£æ§èƒ½åŠ›ï¼š

### âœ… å·²å¯¦ç¾åŠŸèƒ½

1. **ğŸ”— å¾Œç«¯å¯¦æ™‚äº‹ä»¶ API å’Œ WebSocket**
2. **ğŸ“Š å‰ç«¯å¯¦æ™‚äº‹ä»¶å±•ç¤ºçµ„ä»¶**  
3. **âš ï¸ åŸºç¤å‘Šè­¦æ©Ÿåˆ¶**

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾è©³æƒ…

### 1. å¾Œç«¯å¯¦æ™‚äº‹ä»¶ API å’Œ WebSocket

#### ğŸ—‚ï¸ æ ¸å¿ƒæ–‡ä»¶
- `backend/trading-api/handlers/tetragon.go` - Tetragon äº‹ä»¶è™•ç†å™¨
- `backend/trading-api/main.go` - è·¯ç”±é…ç½®æ›´æ–°

#### ğŸŒ API ç«¯é»
```http
GET /api/v1/tetragon/events          # ç²å–äº‹ä»¶åˆ—è¡¨ (æ”¯æŒéæ¿¾)
GET /api/v1/tetragon/alerts          # ç²å–å®‰å…¨å‘Šè­¦åˆ—è¡¨
GET /api/v1/tetragon/statistics      # ç²å–äº‹ä»¶çµ±è¨ˆä¿¡æ¯
GET /api/v1/tetragon/ws              # WebSocket å¯¦æ™‚äº‹ä»¶æµ
```

#### ğŸ“¡ WebSocket åŠŸèƒ½
- **å¯¦æ™‚äº‹ä»¶æ¨é€**: æ¯2ç§’ç”Ÿæˆæ–°çš„å®‰å…¨äº‹ä»¶
- **é€£æ¥ç®¡ç†**: æ”¯æŒå¤šå®¢æˆ¶ç«¯åŒæ™‚é€£æ¥
- **æ¶ˆæ¯é¡å‹**:
  - `welcome` - æ­¡è¿æ¶ˆæ¯
  - `recent_events` - æœ€è¿‘äº‹ä»¶åˆ—è¡¨
  - `security_event` - å¯¦æ™‚å®‰å…¨äº‹ä»¶

#### ğŸ” äº‹ä»¶é¡å‹æ”¯æŒ
1. **é€²ç¨‹åŸ·è¡Œäº‹ä»¶** (`process_exec`)
   - ç›£æ§å¯ç–‘å‘½ä»¤åŸ·è¡Œ (curl, wget, nc, nmap)
   - æª¢æ¸¬å±éšªåƒæ•¸å’Œå¤–éƒ¨é€£æ¥

2. **å…§æ ¸æ¢é‡äº‹ä»¶** (`process_kprobe`)
   - ç›£æ§æ•æ„Ÿæ–‡ä»¶è¨ªå• (/etc/passwd, /etc/shadow)
   - è·Ÿè¹¤ç³»çµ±èª¿ç”¨ (security_file_open)

### 2. å‰ç«¯å¯¦æ™‚äº‹ä»¶å±•ç¤ºçµ„ä»¶

#### ğŸ—‚ï¸ æ ¸å¿ƒæ–‡ä»¶
- `frontend/src/components/TetragonEventStream.tsx` - ä¸»äº‹ä»¶æµçµ„ä»¶
- `frontend/src/pages/Security/index.tsx` - å®‰å…¨é é¢é›†æˆ

#### ğŸ¨ ç•Œé¢åŠŸèƒ½
- **ğŸ“Š çµ±è¨ˆæ¦‚è¦½**: ç¸½äº‹ä»¶æ•¸ã€æ´»èºå‘Šè­¦ã€é—œéµäº‹ä»¶ã€è¿‘æœŸäº‹ä»¶
- **ğŸ”§ æ§åˆ¶é¢æ¿**: å¯¦æ™‚ç›£æ§é–‹é—œã€éæ¿¾å™¨ã€äº‹ä»¶æ•¸é‡æ§åˆ¶
- **ğŸ“‹ äº‹ä»¶åˆ—è¡¨**: å¯¦æ™‚æ›´æ–°çš„å®‰å…¨äº‹ä»¶å±•ç¤º
- **âš ï¸ å‘Šè­¦å±•ç¤º**: é«˜å±å’Œé—œéµäº‹ä»¶çš„å°ˆé–€å‘Šè­¦å€åŸŸ

#### ğŸ¯ äº’å‹•åŠŸèƒ½
- **å¯¦æ™‚éæ¿¾**: æŒ‰åš´é‡ç¨‹åº¦ã€äº‹ä»¶é¡å‹éæ¿¾
- **é€£æ¥ç‹€æ…‹**: WebSocket é€£æ¥ç‹€æ…‹å¯¦æ™‚é¡¯ç¤º
- **è‡ªå‹•é€šçŸ¥**: é«˜å±äº‹ä»¶å½ˆå‡ºé€šçŸ¥æé†’
- **éŸ¿æ‡‰å¼è¨­è¨ˆ**: æ”¯æŒä¸åŒå±å¹•å°ºå¯¸

### 3. åŸºç¤å‘Šè­¦æ©Ÿåˆ¶

#### âš ï¸ å‘Šè­¦ç­‰ç´š
- **ğŸ”´ CRITICAL**: æ•æ„Ÿæ–‡ä»¶è¨ªå•ã€ç³»çµ±å®‰å…¨æ–‡ä»¶æ“ä½œ
- **ğŸŸ  HIGH**: å¯ç–‘å‘½ä»¤åŸ·è¡Œã€å¤–éƒ¨ç¶²çµ¡è¨ªå•
- **ğŸŸ¡ MEDIUM**: ä¸€èˆ¬å®‰å…¨äº‹ä»¶
- **ğŸŸ¢ LOW**: ä½é¢¨éšªäº‹ä»¶

#### ğŸ“‹ å‘Šè­¦å±¬æ€§
```json
{
  "id": "alert-1749176729",
  "timestamp": "2025-06-06T10:25:29+08:00",
  "severity": "CRITICAL",
  "title": "CRITICAL å®‰å…¨äº‹ä»¶æª¢æ¸¬",
  "description": "æ•æ„Ÿæ–‡ä»¶è¨ªå•: /etc/passwd",
  "action": "MONITOR",
  "status": "ACTIVE",
  "event": { /* å®Œæ•´äº‹ä»¶ä¿¡æ¯ */ }
}
```

---

## ğŸ§ª æ¸¬è©¦é©—è­‰

### API æ¸¬è©¦
```bash
# æ¸¬è©¦äº‹ä»¶ API
curl -s http://localhost:30080/api/v1/tetragon/events | jq

# æ¸¬è©¦å‘Šè­¦ API  
curl -s http://localhost:30080/api/v1/tetragon/alerts | jq

# æ¸¬è©¦çµ±è¨ˆ API
curl -s http://localhost:30080/api/v1/tetragon/statistics | jq
```

### WebSocket æ¸¬è©¦
```javascript
// WebSocket é€£æ¥æ¸¬è©¦
const ws = new WebSocket('ws://localhost:30080/api/v1/tetragon/ws');
ws.onmessage = (event) => console.log(JSON.parse(event.data));
```

### ç¤ºä¾‹æ•¸æ“š
```json
{
  "events": [
    {
      "timestamp": "2025-06-06T10:25:29+08:00",
      "event_type": "process_exec", 
      "severity": "HIGH",
      "description": "å¯ç–‘å‘½ä»¤åŸ·è¡Œ: curl è¨ªå•å¤–éƒ¨åŸŸå",
      "process_exec": {
        "process": {
          "pid": 12345,
          "binary": "/usr/bin/curl",
          "arguments": "http://malicious-domain.com",
          "pod": {
            "namespace": "fintech-demo",
            "name": "trading-api-deployment-abc123"
          }
        }
      }
    }
  ],
  "total": 2,
  "success": true
}
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ¨™

### ğŸ“ˆ å¯¦æ™‚çµ±è¨ˆç¤ºä¾‹
```json
{
  "statistics": {
    "total_events": 20,
    "total_alerts": 12,
    "active_alerts": 8,
    "recent_events_count": 12,
    "severity_breakdown": {
      "CRITICAL": 6,
      "HIGH": 6,
      "MEDIUM": 0,
      "LOW": 0
    },
    "event_type_breakdown": {
      "process_exec": 10,
      "process_kprobe": 10
    }
  }
}
```

### âš¡ æ€§èƒ½ç‰¹é»
- **äº‹ä»¶è™•ç†**: æ¯2ç§’ç”Ÿæˆæ–°äº‹ä»¶
- **å…§å­˜ç®¡ç†**: æœ€å¤šä¿å­˜1000å€‹äº‹ä»¶ï¼Œ100å€‹å‘Šè­¦
- **ä¸¦ç™¼æ”¯æŒ**: æ”¯æŒå¤šå€‹ WebSocket å®¢æˆ¶ç«¯
- **éæ¿¾æ•ˆç‡**: å¯¦æ™‚äº‹ä»¶éæ¿¾ï¼Œç„¡é˜»å¡è™•ç†

---

## ğŸ”— ç³»çµ±æ•´åˆ

### èˆ‡ eBPF+Tetragon çš„æ•´åˆ
1. **äº‹ä»¶æ”¶é›†**: å„ªå…ˆå˜—è©¦å¾ kubectl ç²å– Tetragon äº‹ä»¶
2. **æ¨¡æ“¬æ¨¡å¼**: kubectl ä¸å¯ç”¨æ™‚ä½¿ç”¨æ¨¡æ“¬äº‹ä»¶ç”¨æ–¼æ¼”ç¤º
3. **æ•¸æ“šæ ¼å¼**: å®Œå…¨å…¼å®¹ Tetragon äº‹ä»¶æ ¼å¼
4. **æ“´å±•æ€§**: é ç•™æ¥å£æ”¯æŒçœŸå¯¦ eBPF æ•¸æ“š

### èˆ‡ç¾æœ‰ç³»çµ±çš„æ•´åˆ
- **å®‰å…¨é é¢**: æ–°å¢ "Tetragonäº‹ä»¶æµ" æ¨™ç±¤é 
- **API çµ±ä¸€**: ä½¿ç”¨ç›¸åŒçš„è·¯ç”±å‰ç¶´ `/api/v1/`
- **èªè­‰å…¼å®¹**: ç¹¼æ‰¿ç¾æœ‰çš„ CORS å’Œèªè­‰æ©Ÿåˆ¶
- **ç›£æ§é›†æˆ**: èˆ‡ç¾æœ‰ç›£æ§ç³»çµ±ä¸¦è¡Œé‹è¡Œ

---

## ğŸ”œ ä¸‹ä¸€éšæ®µé æœŸ

åŸºæ–¼ç¬¬ä¸€éšæ®µçš„æˆåŠŸå¯¦ç¾ï¼Œä¸‹ä¸€éšæ®µå¯ä»¥è€ƒæ…®ï¼š

1. **çœŸå¯¦ eBPF æ•´åˆ**: é€£æ¥å¯¦éš›çš„ Tetragon éƒ¨ç½²
2. **é«˜ç´šéæ¿¾**: åŸºæ–¼ Podã€å‘½åç©ºé–“ã€æ™‚é–“ç¯„åœçš„è¤‡é›œéæ¿¾
3. **å‘Šè­¦å‹•ä½œ**: è‡ªå‹•é˜»æ­¢ã€éš”é›¢ã€é€šçŸ¥ç­‰éŸ¿æ‡‰æ©Ÿåˆ¶
4. **æ•¸æ“šæŒä¹…åŒ–**: äº‹ä»¶å’Œå‘Šè­¦çš„æ•¸æ“šåº«å­˜å„²
5. **åˆ†æå„€è¡¨æ¿**: è¶¨å‹¢åˆ†æã€å¨è„…æƒ…å ±æ•´åˆ

---

## ğŸš€ å•Ÿå‹•èªªæ˜

### å¾Œç«¯å•Ÿå‹•
```bash
cd backend/trading-api
go run . 
# æˆ–
./trading-api
```

### å‰ç«¯è¨ªå•
1. è¨ªå• http://localhost:3000/security
2. é»æ“Š "Tetragonäº‹ä»¶æµ" æ¨™ç±¤é 
3. è§€å¯Ÿå¯¦æ™‚äº‹ä»¶æµå’Œå‘Šè­¦

### æ—¥èªŒç›£æ§
```bash
tail -f backend/trading-api/trading-api.log
```

---

**âœ… ç¬¬ä¸€éšæ®µæ ¸å¿ƒåŠŸèƒ½å·²å…¨éƒ¨å¯¦ç¾ä¸¦æ¸¬è©¦é€šéï¼** 

# Tetragon eBPF æ•´åˆèªªæ˜

## ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React å‰ç«¯    â”‚â”€â”€â”€â”€â”‚  Trading API    â”‚â”€â”€â”€â”€â”‚   Kubernetes    â”‚
â”‚  (WebSocket)    â”‚    â”‚  (Go Backend)   â”‚    â”‚   + Tetragon    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Tetragon åŸç”Ÿç›£æ§ vs æ¼”ç¤ºç³»çµ±å°æ¯”

### ğŸ”§ Tetragon å®˜æ–¹å·¥å…·

#### tetra CLI - å®˜æ–¹å‘½ä»¤è¡Œç•Œé¢
```bash
# å®‰è£ tetra CLI
curl -L https://github.com/cilium/tetragon/releases/latest/download/tetra-linux-amd64.tar.gz | tar -xz
sudo mv tetra /usr/local/bin

# å¯¦æ™‚æŸ¥çœ‹äº‹ä»¶
tetra getevents -o compact

# éæ¿¾ç‰¹å®š Pod çš„äº‹ä»¶
tetra getevents --pods <pod-name>

# JSON æ ¼å¼å®Œæ•´äº‹ä»¶
tetra getevents
```

#### å…§å»º Prometheus Metrics
Tetragon åŸç”Ÿæ”¯æ´ Prometheus æŒ‡æ¨™ï¼š

```yaml
# Kubernetes ç’°å¢ƒé»˜èªå•Ÿç”¨
tetragon:
  prometheus:
    enabled: true  # é»˜èªé–‹å•Ÿ
    port: 2112     # metrics ç«¯å£
    serviceMonitor:
      enabled: true  # Prometheus è‡ªå‹•ç™¼ç¾
```

æŸ¥çœ‹æŒ‡æ¨™ï¼š
```bash
# Port forward metrics ç«¯å£
kubectl port-forward svc/tetragon 2112:2112

# è¨ªå• metrics ç«¯é»
curl localhost:2112/metrics
```

#### Grafana æ•´åˆ
å¯ä»¥ç›´æ¥æ•´åˆç¾æœ‰çš„ Grafana å’Œ Prometheus å †æ£§ã€‚

### ğŸ¯ æ¼”ç¤ºç³»çµ±å„ªå‹¢

#### é‡‘èç‰¹å®šå ´æ™¯
- é‡å°äº¤æ˜“ã€é¢¨æ§ã€åˆè¦ç­‰æ¥­å‹™å ´æ™¯
- è‡ªå®šç¾©å®‰å…¨è¦å‰‡å’Œå‘Šè­¦é‚è¼¯
- èˆ‡å¾®æœå‹™æ¶æ§‹ç„¡ç¸«æ•´åˆ

#### ç¾ä»£åŒ–ç”¨æˆ¶é«”é©—
- React éŸ¿æ‡‰å¼ UI
- å¯¦æ™‚ WebSocket æ¨é€
- äº¤äº’å¼å„€è¡¨æ¿å’Œéæ¿¾å™¨

#### ä¼æ¥­ç´šåŠŸèƒ½
- å¤šç§Ÿæˆ¶æ”¯æ´
- è§’è‰²åŸºç¤å­˜å–æ§åˆ¶
- å¯©è¨ˆæ—¥èªŒå’Œåˆè¦å ±å‘Š

### ğŸš€ æ··åˆä½¿ç”¨æ–¹æ¡ˆ

å»ºè­°åŒæ™‚ä½¿ç”¨å…©ç¨®æ–¹æ¡ˆä»¥ç²å¾—æœ€ä½³æ•ˆæœï¼š

#### 1. é–‹ç™¼å’Œèª¿è©¦éšæ®µ
- ä½¿ç”¨ `tetra CLI` é€²è¡Œå¿«é€Ÿäº‹ä»¶æŸ¥çœ‹å’Œèª¿è©¦
- åˆ©ç”¨å®˜æ–¹ Prometheus metrics é€²è¡Œæ€§èƒ½ç›£æ§

#### 2. ç”Ÿç”¢ç›£æ§éšæ®µ
- ä½¿ç”¨æ¼”ç¤ºç³»çµ±æä¾›æ¥­å‹™ç‰¹å®šçš„ç›£æ§å„€è¡¨æ¿
- å®˜æ–¹å·¥å…·ä½œç‚ºåº•å±¤ç›£æ§å’Œæ•…éšœæ’æŸ¥å·¥å…·

#### 3. æ•´åˆæ¶æ§‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¼”ç¤ºç³»çµ± UI    â”‚    â”‚  Grafanaå®˜æ–¹    â”‚
â”‚ (æ¥­å‹™ç›£æ§)      â”‚    â”‚ (ç³»çµ±ç›£æ§)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Tetragon      â”‚
         â”‚  (æ•¸æ“šæº)       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4. å…·é«”å¯¦æ–½æ­¥é©Ÿ

**å®‰è£ tetra CLIï¼š**
```bash
# åœ¨æ¼”ç¤ºç³»çµ±ç›®éŒ„ä¸­
curl -L https://github.com/cilium/tetragon/releases/latest/download/tetra-linux-amd64.tar.gz | tar -xz
sudo mv tetra /usr/local/bin

# é©—è­‰å®‰è£
tetra version
```

**é…ç½® Prometheus æŠ“å–ï¼š**
```yaml
# åœ¨ prometheus.yml ä¸­æ·»åŠ 
- job_name: 'tetragon'
  static_configs:
    - targets: ['tetragon:2112']
```

**å‰µå»º Grafana å„€è¡¨æ¿ï¼š**
- å°å…¥ Tetragon å®˜æ–¹å„€è¡¨æ¿æ¨¡æ¿
- é…ç½®èˆ‡æ¼”ç¤ºç³»çµ±çš„æ•¸æ“šé—œè¯

é€™æ¨£å¯ä»¥åŒæ™‚äº«å—å®˜æ–¹å·¥å…·çš„å¼·å¤§åŠŸèƒ½å’Œæˆ‘å€‘æ¼”ç¤ºç³»çµ±çš„å®šåˆ¶åŒ–ç‰¹æ€§ã€‚ 